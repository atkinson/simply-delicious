<!--
    Copyright 2009 Rich Atkinson http://jetfar.com/
    
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<script type="text/javascript" src="saXMLUtils.js"></script>
<script>

// TODO
// Separate initiation from loading history.
// I think if setting up the bookmarks folder was done at a different time to loading bookmarks, we wouldn't have a problem.
// OptionsPage - username, password, load all bookmarks, add "tags" to titles, save in a new tab?

Chromium = {
    folderName: 'Simply Delicious',
    folderID: function(){return localStorage["folderID"]},
    _BOOKMARK_BAR: '1',
    _OTHER_BOOKMARKS: '2',

    _createFolder: function(callback){
	    localStorage["folderID"] = undefined;
	    chrome.bookmarks.create({'parentId':Chromium._OTHER_BOOKMARKS, 'title':Chromium.folderName}, function(newFolder){
		localStorage["folderID"] = newFolder.id;
	    });
	    setTimeout("callback && callback()",250); // very dirty hack - Stupid chrome.bookmarks.create doesn't pass callbacks along
	    	    
    },
    init: function(callback){
	    if(Chromium.folderID()) {
		try {
		    chrome.bookmarks.get(Chromium.folderID(), function(results){
			if(results && results.length && results[0].title == Chromium.folderName) {
			    console.log('found folder: '+ results[0].title);
			} else {
			    Chromium._createFolder();
			};
		    });
		    callback && callback();
		} catch(e) {
		  console.log(e);
		  Chromium._createFolder(callback);
		};
	    } else {
		Chromium._createFolder(callback);
	    };
    },
    sync: function(){
	for (var i = 0; i < Delicious.posts.length; i++) {
	    var url = Delicious.posts[i].href;
	    var title = Delicious.posts[i].description;
	    var tags = Delicious.posts[i].tag;
	    Chromium.insert(url, title, tags);
	};
	console.log('Delicious sync complete');
    },
    insert: function(url, title, tags){
	var label = title + ' (' + tags + ')';
	chrome.bookmarks.search(url, function(results){
	    if(results.length == 0) chrome.bookmarks.create({'parentId':Chromium.folderID(), 'title':label, 'url':url});
	});
    }
}

Delicious = {
    user: 'rich.atkinson',
    posts: [],
    add: function(tab){
      chrome.tabs.getSelected(null, function(tab){
	  var url = 'http://delicious.com/save?url='+encodeURIComponent(tab.url)+'&title='+encodeURIComponent(tab.title)+'&v=5&jump=yes'; console.log('delicious: '+url);
	  chrome.tabs.create({'url': url });
	  //chrome.tabs.update(tab.id, {'url': url});
      });
    },

    sync: function(uname, callback){
      var uname = uname || Delicious.user;
      var url = 'http://feeds.delicious.com/v2/json/' + uname + '?count=100'; console.log('requested '+url);
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.send();
      xhr.onreadystatechange = function() {
	if (xhr.readyState == 4) {
	    Delicious.posts = JSON.parse(xhr.responseText);
	    Chromium.init(function(){ 
		console.log('Chromium inited, syncing...');
		Chromium.sync();
	    });
	};
      }
    },

    // Delicious.apiPostsAll('rich.atkinson', 'passwd', function(posts){console.log(posts);});
    apiPostsAll: function(user, passwd, callback){
	var user = user || localStorage['delicious_user'];
	var passwd = passwd || localStorage['delicious_passwd'];
	if (user && passwd) {
	    var url = 'https://'+user+':'+passwd+'@api.del.icio.us/v1/posts/all';
	    var xhr = new XMLHttpRequest();
	    xhr.open("GET", url, true);
	    xhr.send();
	    xhr.onreadystatechange = function() {
		if (xhr.readyState == 4) {
		    if (xhr.status == 200) {
			var data = XMLObjectifier.xmlToJSON(xhr.responseXML);
			Delicious.posts = data.post;
			callback && callback();  //data.post is an array
		    } else {
			console.log("There was a problem retrieving the XML data:\n" + xhr.statusText);
		    }
		};
	    };
	} else throw "user or passwd missing";
    },
};


chrome.browserAction.onClicked.addListener(function(tab) {
    Delicious.add(tab);
});


//Delicious.sync();
Delicious.apiPostsAll('rich.atkinson', 'passwd', function(){
    Chromium.init(function(){ 
	console.log('Chromium inited, syncing...');
	Chromium.sync();
    });
});

</script>

